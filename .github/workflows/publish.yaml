name: Publish

on:
  workflow_dispatch:
    inputs:
      vibingbase-download-url:
        type: string
        required: true
      vibingbase-download-server:
        type: choice
        options: [origin, proxy]
        required: true
      vibingbase-app-env:
        type: choice
        options: [development, production]
        required: true
      vibingbase-app-id:
        type: string
        required: true

concurrency:
  group: ${{ github.workflow }} ${{ inputs.vibingbase-app-id }}

jobs:
  publish:
    strategy:
      matrix:
        platform: [macos-latest, windows-latest]
    name: ${{ github.workflow }} ${{ inputs.vibingbase-app-id }} (${{ matrix.platform }})
    runs-on: ${{ matrix.platform }}
    permissions:
      contents: write
    steps:
      - uses: levibostian/action-hide-sensitive-inputs@v1
      - uses: actions/checkout@v4
      - uses: fregante/setup-git-user@v2
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          cache: pnpm
          node-version-file: .nvmrc
      - run: pnpm install
      - run: node setup-app.js
        env:
          VIBINGBASE_PROXY_DEVELOPMENT_SECRET: ${{ secrets.PROXY_DEVELOPMENT_SECRET }}
          VIBINGBASE_PROXY_PRODUCTION_SECRET: ${{ secrets.PROXY_PRODUCTION_SECRET }}
          VIBINGBASE_DOWNLOAD_SERVER: ${{ inputs.vibingbase-download-server }}
          VIBINGBASE_DOWNLOAD_URL: ${{ inputs.vibingbase-download-url }}
          VIBINGBASE_APP_ENV: ${{ inputs.vibingbase-app-env }}
          VIBINGBASE_APP_ID: ${{ inputs.vibingbase-app-id }}
          VIBINGBASE_APP_DIR: ${{ runner.temp }}/${{ inputs.vibingbase-app-id }}
      - run: pnpm install
        working-directory: ${{ runner.temp }}/${{ inputs.vibingbase-app-id }}
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ runner.os == 'macOS' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}
      - uses: swatinem/rust-cache@v2
        with:
          shared-key: ${{ inputs.vibingbase-app-id }}
          workspaces: ${{ runner.temp }}/${{ inputs.vibingbase-app-id }}/src-tauri
      - if: runner.os == 'macOS'
        id: prepare-apple-signing-identity
        name: Prepare Apple signing identity
        run: |
          echo $APPLE_CERTIFICATE | base64 --decode > certificate.p12
          security create-keychain -p github-actions build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p github-actions build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          security import certificate.p12 -k build.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k github-actions build.keychain
          rm certificate.p12
          APPLE_SIGNING_INFO=$(security find-identity -v -p codesigning build.keychain | grep "Developer ID Application")
          APPLE_SIGNING_IDENTITY=$(echo "$APPLE_SIGNING_INFO" | awk -F'"' '{print $2}')
          echo "APPLE_SIGNING_IDENTITY=$APPLE_SIGNING_IDENTITY" >> $GITHUB_OUTPUT
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
      - if: runner.os == 'Windows'
        shell: pwsh
        run: Invoke-WebRequest -Uri "https://github.com/Levminer/trusted-signing-cli/releases/download/0.8.0/trusted-signing-cli.exe" -OutFile "$env:windir\trusted-signing-cli.exe"
      - uses: tauri-apps/tauri-action@v0
        with:
          args: ${{ runner.os == 'macOS' && '--target universal-apple-darwin' || '' }} --config src-tauri/tauri.release.conf.json
          tauriScript: pnpm exec tauri
          projectPath: ${{ runner.temp }}/${{ inputs.vibingbase-app-id }}
          tagName: ${{ inputs.vibingbase-app-env }}-${{ inputs.vibingbase-app-id }}@v__VERSION__
          releaseName: ${{ inputs.vibingbase-app-env }}-${{ inputs.vibingbase-app-id }}@v__VERSION__
          includeUpdaterJson: false
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_ID: ${{ vars.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ vars.APPLE_TEAM_ID }}
          APPLE_SIGNING_IDENTITY: ${{ steps.prepare-apple-signing-identity.outputs.APPLE_SIGNING_IDENTITY }}
          AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
          AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - shell: bash
        run: rm -rf ${{ runner.temp }}/${{ inputs.vibingbase-app-id }}/src-tauri/target${{ runner.os == 'macOS' && '/universal-apple-darwin/' || '/' }}release/bundle
